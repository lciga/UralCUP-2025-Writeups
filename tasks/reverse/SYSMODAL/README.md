# SYSMODAL Reloaded | Hard | Reverse

## Информация

>Что за программа вообще записана на старенький диск моего отца?!
>
>И... что такое Ring-0?

## Выдать участникам

[Архив](public/sysmodal.tar.gz)

## Описание

Распаковка, отладка, переписывание функции дешифровки, соблюдение условия по системному времени и вызов SHELL_SYSMODAL_Message.

## Решение

Запуск программы на NT ограничивается лишь MessageBox, но она заметно больше по размеру, чем любая подобная "пустышка".
[Image](images/image1.jpg)
При открытии лоадера в утилите для статического анализа заметим, что файл упакован модифицированным UPX.
[Image](images/image2.jpg)
Сигнатура напоминает UPX 3.03 - распаковываем им программу с флагом -d. Также внутри программы, в секции ресурсов, содержится зашифрованный файл (драйвер), его можно достать с помощью ResourceHacker.
IDA при анализе упускает некоторые детали. Но в целом по "sysmod.vxd" можем понять, что задание как-то связано с Windows 9x.
[Image](images/image3.jpg)
Загружаем файл в SoftICE - он позволит нам без потерь рассмотреть инструкции, вызываемые в Ring0. Заходим в INT 5 (для нас - вход в Ring0). Лоадер проверяет значения CMOS RTC: год (32h = 2032 год) и день (4h = 4 день каждого месяца). 
[Image](images/image4.jpg)
При соответствии системной даты с условием, в заранее выделенные в Ring0 переменные заполняются значение 7h, в набор байтов XOR-ключа загружается некоторая последовательность (4Eh, 21h, 6h, 4Dh).
[Image](images/image5.jpg)
Ниже, после IRETD (для нас - выход из Ring0), видно функцию дешифровки, которая, по сути, является затычкой, до неё программа не доходит, но она играет важнейшую роль в расшифровке драйвера. По факту это простой циклический xor, но со смещённой обработкой нулевого индекса.
[Image](images/image6.jpg)

Переписываем функцию и получаем расшифованный драйвер.
[Код](solve/decrypt.py)

Можем продолжить анализ с помощью дизассемблера, или, что легче, перенести расшифрованный драйвер обратно на Win9x в одну папку с лоадером, переименовать его в sysmod.vxd, выставить нужную дату, запустить лоадер и получить кастомный BSoD.
[Image](images/image7.jpg)

## Флаг

`UralCTF{w3lc0m3_2_th3_r1ng0}`
